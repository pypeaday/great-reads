{% extends "base.html" %}

{% block content %}
<div class="max-w-4xl mx-auto">
    {% if not user %}
    <div class="flex justify-center space-x-4">
        <a href="/login" class="px-6 py-3 bg-theme-accent text-white rounded-lg hover:opacity-90 transition-opacity text-lg">
            <i class="fas fa-sign-in-alt mr-2"></i>Login
        </a>
        <a href="/register" class="px-6 py-3 bg-theme-bg2 text-theme-fg rounded-lg hover:bg-theme-bg border border-theme-bg2 transition-colors text-lg">
            <i class="fas fa-user-plus mr-2"></i>Register
        </a>
    </div>
    {% else %}
    <div class="mb-6">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold">{{ user.email.split('@')[0] }}'s Reading Dashboard</h1>
            <a href="/books/new" class="px-4 py-2 bg-theme-accent text-white rounded-md hover:opacity-90 transition-opacity">
                <i class="fas fa-plus mr-2"></i>Add Book
            </a>
        </div>
        
        <!-- Quick Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            {% for status in book_statuses %}
            {% set count = books_by_status.get(status, [])|length %}
            <div class="bg-theme-bg1 rounded-lg p-4 border border-theme-bg2 text-center">
                <div class="text-2xl font-bold mb-1">{{ count }}</div>
                <div class="text-sm text-theme-fg1">{{ status.value }}</div>
            </div>
            {% endfor %}
        </div>

        <!-- Book Dashboard -->
        {% if books_by_status %}
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {% for status in book_statuses %}
            {% if status in books_by_status %}
            <div class="bg-theme-bg1 rounded-lg shadow-lg border border-theme-bg2">
                <div class="p-4 border-b border-theme-bg2">
                    <button class="w-full flex justify-between items-center text-left"
                            onclick="toggleSection('{{ status.name }}')"
                            aria-expanded="true"
                            aria-controls="section-{{ status.name }}">
                        <div class="flex items-center">
                            <h2 class="text-xl font-bold">{{ status.value }}</h2>
                            <span class="ml-3 px-2 py-1 bg-theme-bg2 rounded-full text-sm">
                                {{ books_by_status[status]|length }}
                            </span>
                        </div>
                        <i class="fas fa-chevron-down transition-transform" id="icon-{{ status.name }}"></i>
                    </button>
                </div>
                
                <div id="section-{{ status.name }}" class="max-h-[400px] overflow-y-auto">
                    <div class="divide-y divide-theme-bg2">
                        {% for book in books_by_status[status] %}
                        <div class="p-4 hover:bg-theme-bg2/50 transition-colors">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-semibold">{{ book.title }}</h3>
                                    <p class="text-theme-fg1">{{ book.author }}</p>
                                </div>
                                {% if book.rating is not none %}
                                <div class="text-theme-accent">
                                    {{ "★" * book.rating }}{{ "☆" * (3 - book.rating) }}
                                </div>
                                {% endif %}
                            </div>
                            {% if book.start_date and status.value == "Currently Reading" %}
                            <div class="mt-2 text-sm text-theme-fg1">
                                Started: {{ book.start_date.strftime('%Y-%m-%d') }}
                            </div>
                            {% endif %}
                            {% if book.completion_date and status.value == "Completed" %}
                            <div class="mt-2 text-sm text-theme-fg1">
                                Finished: {{ book.completion_date.strftime('%Y-%m-%d') }}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>

        <script>
            function toggleSection(sectionId) {
                const section = document.getElementById('section-' + sectionId);
                const icon = document.getElementById('icon-' + sectionId);
                const button = icon.parentElement;
                
                if (section.style.display === 'none') {
                    section.style.display = 'block';
                    icon.style.transform = 'rotate(0deg)';
                    button.setAttribute('aria-expanded', 'true');
                } else {
                    section.style.display = 'none';
                    icon.style.transform = 'rotate(-90deg)';
                    button.setAttribute('aria-expanded', 'false');
                }
            }
        </script>
        {% else %}
        <div class="bg-theme-bg1 rounded-lg shadow-lg p-6 border border-theme-bg2 text-center">
            <p class="text-theme-fg1 mb-4">You haven't added any books yet.</p>
            <a href="/books/new" class="px-4 py-2 bg-theme-accent text-white rounded-md hover:opacity-90 transition-opacity">
                <i class="fas fa-plus mr-2"></i>Add Your First Book
            </a>
        </div>
        {% endif %}

    </div>
    {% endif %}
</div>
{% endblock %}
